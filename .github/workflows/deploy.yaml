name: Deploy to Cloud Run

# main ブランチに push されたとき、または Pull Request が作られたとき等をトリガーに
on:
  push:
    branches:
      - main
  pull_request:

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: 2024/genai-app-patterns  # ここに指定

    steps:
      # (1) リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v2

      # (2) gcloud CLIのセットアップ (Google提供の公式Action)
      - name: Auth with GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          export_environment_variables: true

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      # (3) Docker pushの認証 (必要な場合)
      - name: Configure Docker auth
        run: gcloud auth configure-docker

      # (4) Terraformのセットアップ
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2

      # (5) Terraform init/plan/apply
      - name: Terraform Init & Apply
        run: |
          cd tf
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="prefix=terraform/state" \
            -reconfigure
          terraform apply \
            -target=google_identity_platform_config.default \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -auto-approve

      # (6) Cloud Run へのデプロイ
      - name: Deploy to Cloud Run
        run: |
          # 例: Next.js プロジェクトが src/ai-organizer というディレクトリにある場合
          gcloud run deploy ai-organizer \
            --source ./src/ai-organizer \
            --service-account ai-organizer-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
            --allow-unauthenticated \
            --region asia-northeast1 \
            --quiet
